<script>
  async function fetchPost(slug) {
    const query = encodeURIComponent(`*[_type == "journalPost" && slug.current == "${slug}"][0]{
      title,
      publishedAt,
      body,
      "imageUrl": mainImage.asset->url
    }`);

    const url = `https://fbog0kgj.api.sanity.io/v2021-10-21/data/query/production?query=${query}`;

    try {
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const result = await response.json();

      // Check if valid Sanity API response
      if (!result || !result.result) {
        throw new Error("Invalid response structure");
      }

      return result.result;

    } catch (err) {
      console.error("Fetch error:", err);
      const container = document.getElementById("post-content");
      container.innerHTML = `<p>Oops! Failed to load post: ${err.message}</p>`;
    }
  }

  function getSlugFromURL() {
    const params = new URLSearchParams(window.location.search);
    return params.get('slug');
  }

  function formatDate(dateString) {
    const date = new Date(dateString);
    return isNaN(date) ? "Invalid Date" : date.toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric"
    });
  }

  async function renderPost() {
    const slug = getSlugFromURL();
    const container = document.getElementById("post-content");

    if (!slug) {
      container.innerHTML = "<p>Error: No slug found in URL.</p>";
      return;
    }

    const post = await fetchPost(slug);

    if (!post) return;

    container.innerHTML = `
      <h1>${post.title}</h1>
      <p class="date">${post.publishedAt ? formatDate(post.publishedAt) : "No date"}</p>
      ${post.imageUrl ? `<img src="${post.imageUrl}" alt="${post.title}" />` : ""}
      <div class="post-body">${post.body}</div>
    `;
  }

  document.addEventListener("DOMContentLoaded", renderPost);
</script>
