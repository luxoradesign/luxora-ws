<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Journal Post</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <main class="journal-post-wrapper">
    <div id="post-content">
      <p>Loading...</p>
    </div>
  </main>

  <script type="module">
    async function fetchPost(slug) {
      const query = encodeURIComponent(`*[_type == "journalPost" && slug.current == "${slug}"][0]{
        title,
        publishedAt,
        body,
        "imageUrl": mainImage.asset->url
      }`);
      const url = `https://fbog0kgj.api.sanity.io/v2021-10-21/data/query/production?query=${query}`;

      try {
        const response = await fetch(url);

        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const result = await response.json();
        if (!result.result) throw new Error("Post not found.");
        return result.result;
      } catch (err) {
        const container = document.getElementById("post-content");
        container.innerHTML = `<p style="color:red;">Failed to load: ${err.message}</p>`;
        console.error("Fetch error:", err);
      }
    }

    function getSlugFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get('slug');
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return isNaN(date) ? "Invalid Date" : date.toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric"
      });
    }

    async function renderPost() {
      const slug = getSlugFromURL();
      const container = document.getElementById("post-content");
      if (!slug) {
        container.innerHTML = "<p>Error: No slug found in URL.</p>";
        return;
      }

      const post = await fetchPost(slug);
      if (!post) return;

      container.innerHTML = `
        <h1>${post.title}</h1>
        <p class="date">${post.publishedAt ? formatDate(post.publishedAt) : "<em>No date available</em>"}</p>
        ${post.imageUrl ? `<img src="${post.imageUrl}" alt="${post.title}" />` : ""}
        <div id="post-body" class="post-body"></div>
      `;

      // Render Portable Text manually (basic version)
      const bodyContainer = document.getElementById("post-body");

      if (post.body && Array.isArray(post.body)) {
        post.body.forEach(block => {
            if (block._type === 'block' && block.children) {
                const p = document.createElement('p');
                block.children.forEach(child => {
                    if (child.text) {
                        const span = document.createElement('span');
                        span.textContent = child.text;
                        p.appendChild(span);
                    }
                });
                bodyContainer.appendChild(p);
            }
        });
      } else {
        bodyContainer.innerHTML = "<em>No content available</em>";
      }
    }

    document.addEventListener("DOMContentLoaded", renderPost);
  </script>
</body>
</html>
